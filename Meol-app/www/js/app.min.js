var directory={config:{root:window.location.pathname.replace(/\/(?:index.html)?$/,"")},dao:{},data:{},models:{},views:{},utils:{}};$().ready(function(){init()}); function init(){window.heightScreen=$(window).height();window.widthScreen=$(window).width();window.deferreds=[];window.dontShowModal="";$("body").addClass("ui-disabled");$("body").append("<img id='dataloader-img' src='css/images/ajax-loader.gif'/>");initDB();directory.utils.templateLoader.load("feedback-page credit-page profil-page profil-table d3-graph-panel request-panel gallery-taxon-list gallery-panel home-page search-page taxon-panel taxon-list-item gallery-detail gallery-page gallery-list-item play-list-gallery play-gallery play-gameboard".split(" "));$.when.apply(null, deferreds).done(function(){directory.data.galleriesList=new directory.models.GalleriesCollection;directory.data.galleriesList.fetch({success:function(a){directory.app=new directory.Router;Backbone.history.start();$("#dataloader-img").remove();$("body").removeClass("ui-disabled")}})})} function initDB(){directory.db=openDatabase("meol-taxon","1.0","db meol-taxon",20971520);initializeDB(directory.db);var a=$.Deferred();deferreds.push(a);$.when(runQuery("SELECT * FROM Ttaxons",[])).done(function(b){var c=[];0==b.rows.length&&(c.push(loadTaxaFile(directory.db)),c.push(loadItemsFile(directory.db)),c.push(loadGalleryFile(directory.db)),c.push(runQuery("INSERT INTO Tprofil (pseudo, avatar) VALUES ('Player 1', null)",[])));$.when.apply(this,c).then(function(){return a.resolve()})}).fail(function(b){return a.resolve()})} directory.utils.templateLoader={templates:{},load:function(a){var b=this;$.each(a,function(a,d){deferreds.push($.get("tpl/"+d+".html",function(a){b.templates[d]=a}))})},get:function(a){return this.templates[a]}};var fiboSuite=function(){var a=[0,1],b=function(c){if(2>c)return c;if(a[c])return a[c];a[c]=b(c-1)+b(c-2);return a[c]};return b};function shuffleContinent(a){for(var b=0,c,d="",g=a.length-1;-1<g;)b=Math.floor(Math.random()*g),c=a[g],d=a[b],a[g]=d,a[b]=c,g-=1;return a} function shuffle(a){var b=a.length,c,d;if(0===b)return!1;for(;--b;)c=Math.floor(Math.random()*(b+1)),d=a[b],a[b]=a[c],a[c]=d;return a}function capitaliseFirstLetter(a){return a.charAt(0).toUpperCase()+a.slice(1)} function initializeDB(a){try{a&&(a="CREATE TABLE IF NOT EXISTS Ttaxons (Ttax_PK_Id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, fk_collectionid  NVARCHAR(200), pageid INTEGER, taxonConceptId INTEGER, taxonName  NVARCHAR(200), flathierarchy text, preferredCommonNames  NVARCHAR(200), textDesc_objectid  NVARCHAR(200), textDesc_title  NVARCHAR(200), textDesc_credits  NVARCHAR(200), textDesc_description text, iucnStatus  NVARCHAR(200), image_objectid  NVARCHAR(200), image_title NVARCHAR(200), image_credits  NVARCHAR(500), image_fileName  NVARCHAR(200))",deferreds.push(runQuery(a, [])),a="CREATE TABLE IF NOT EXISTS Tgallery (Tgallery_PK_Id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, collectionid  NVARCHAR(200),  name  NVARCHAR(200),  description  NVARCHAR(2000), logo  NVARCHAR(200), level INTEGER, ordre INTEGER, active NVARCHAR(10))",deferreds.push(runQuery(a,[])),a="CREATE TABLE IF NOT EXISTS Titems (Titem_PK_Id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, fk_collectionid INTEGER, object_id INTEGER, pageid INTEGER, weightIucn INTEGER, weightContinent INTEGER, type  NVARCHAR(20), taxonConceptId INTEGER, taxonName  NVARCHAR(200),  preferredCommonNames  NVARCHAR(200), iNat  NVARCHAR(200), title  NVARCHAR(200), filename  NVARCHAR(200))", deferreds.push(runQuery(a,[])),a="CREATE TABLE IF NOT EXISTS Tprofil (Tprofil_PK_Id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, pseudo  NVARCHAR(50), avatar  NVARCHAR(200),email  NVARCHAR(80), creationDate DATETIME)",deferreds.push(runQuery(a,[])),deferreds.push(runQuery("CREATE TABLE IF NOT EXISTS Tscore (Tscore_PK_Id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, fk_profil INTEGER, fk_gallery INTEGER, gameDate DATETIME, nbQuestionTotal INTEGER, nbAnswerGood INTEGER, nbAnswerGoodSequence INTEGER, score INTEGERnbQuestionTotalAfrica INTEGER ,nbQuestionTotalAsia INTEGER ,nbQuestionTotalAntartica INTEGER ,nbQuestionTotalEurope INTEGER ,nbQuestionTotalOceania INTEGER ,nbQuestionTotalAmericaNorth INTEGER ,nbQuestionTotalAmericaSouth INTEGER,nbAnswerGoodAfrica INTEGER ,nbAnswerGoodAsia INTEGER ,nbAnswerGoodAntartica INTEGER ,nbAnswerGoodEurope INTEGER ,nbAnswerGoodOceania INTEGER ,nbAnswerGoodAmericaNorth INTEGER ,nbAnswerGoodAmericaSouth INTEGER )", [])))}catch(b){console.log(b)}} function loadTaxaFile(a){var b=$.Deferred(),c=[];$.getJSON("data/detail_Taxon.json",function(a){$.each(a,function(a,b){var d=JSON.stringify(b.flathierarchy);c.push(runQuery("Insert into Ttaxons(fk_collectionid , pageid , taxonConceptId, taxonName , flathierarchy, preferredCommonNames , textDesc_objectid , textDesc_title , textDesc_credits , textDesc_description, iucnStatus , image_objectid , image_title, image_credits , image_fileName ) values(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)",[b.collectionid,b.pageid, b.taxonConceptId,b.taxonName,d,b.preferredCommonNames,b.textDesc_objectid,b.textDesc_title,b.textDesc_credits,b.textDesc_description,b.iucnStatus,b.image_objectid,b.image_title,b.image_credits,b.image_fileName]))});$.when.apply(this,c).then(function(){return b.resolve()})});return b.promise()} function loadGalleryFile(a){var b=$.Deferred(),c=[];$.getJSON("data/collection_metadata.json",function(a){$.each(a,function(a,b){c.push(runQuery("Insert into  Tgallery (collectionid, name,  description, logo, level, ordre, active) values(?,?,?,?,?,?,?)",[a,b.name,b.description,b.logo,b.level,b.ordre,b.active]))});$.when.apply(this,c).then(function(){return b.resolve()})});return b.promise()} function loadItemsFile(a){var b=$.Deferred(),c=[];$.getJSON("data/items.json",function(a){$.each(a,function(a,b){c.push(runQuery("Insert into  Titems (fk_collectionid, object_id, pageid, weightIucn, weightContinent,type, taxonConceptId, taxonName, preferredCommonNames, iNat, title, filename) values(?,?,?,?,?,?,?,?,?,?,?,?)",[b.fk_collection,b.pageid,b.pageid,b.weightIUCN,b.weightContinent,b.type,b.taxonConceptId,b.taxonName,b.common_name,b.iNat,b.title,b.filename]))});$.when.apply(this,c).then(function(){return b.resolve()})}); return b.promise()}function runQuery(a,b){return $.Deferred(function(c){directory.db.transaction(function(d){d.executeSql(a,b,successWrapper(c),failureWrapper(c))})})}function successWrapper(a){return function(b,c){a.resolve(c)}}function failureWrapper(a){return function(b,c){console.log("failureWrapper");console.log(c);a.reject(c)}} Backbone.sync=function(a,b,c){var d=new b.dao(directory.db);"read"===a?b.attributes?b.attributes.taxonConceptId?d.findByTaxonConceptId(b.attributes.taxonConceptId,function(a){c.success(a)}):b.attributes.taxonName?d.taxonName(b.taxonName,function(a){c.success(a)}):b.attributes.collectionid?d.findByGalleryId(b.attributes.collectionid,function(a){c.success(a)}):b.attributes.fk_collectionid?d.findByGalleryId(b.attributes.fk_collection,function(a){c.success(a)}):b.attributes.pseudo?d.findByPseudo(b.attributes.pseudo, function(a){c.success(a)}):b.attributes.Tprofil_PK_Id?d.findById(b.attributes.Tprofil_PK_Id,function(a){c.success(a)}):d.findAll(function(a){c.success(a)}):d.findAll(function(a){c.success(a)}):"create"===a?b.attributes?b.attributes.pseudo?d.updatePseudoProfile(b,function(a){c.success(a)}):b.attributes.fk_gallery&&d.createScore(b,function(a){c.success(a)}):d.createScore(b,function(a){c.success(a)}):"update"===a?d.updateGalleryActive(b,function(a){c.success(a)}):"delete"===a&&d.destroy(b,function(a){c.success(a)})}; directory.dao.TaxonDAO=function(a){this.db=a};directory.dao.GalleryDAO=function(a){this.db=a};directory.dao.ItemDAO=function(a){this.db=a};directory.dao.ProfilDAO=function(a){this.db=a};directory.dao.ScoreDAO=function(a){this.db=a}; _.extend(directory.dao.TaxonDAO.prototype,{findByName:function(a,b){this.db.transaction(function(c){c.executeSql("SELECT fk_collectionid , pageid , taxonConceptId, taxonName , flathierarchy, preferredCommonNames , textDesc_objectid , textDesc_title , textDesc_credits , textDesc_description, iucnStatus , image_objectid , image_title, image_credits , image_fileName FROM Ttaxons WHERE preferredCommonNames || taxonName LIKE ?  LIMIT 20",["%"+a+"%"],function(a,c){for(var h=c.rows.length,e=[],f=0;f<h;f+= 1)e[f]=c.rows.item(f);b(e)})},function(a,b){console.log(a)})},findByTaxonConceptId:function(a,b){this.db.transaction(function(c){c.executeSql("SELECT fk_collectionid , pageid , taxonConceptId, taxonName , flathierarchy, preferredCommonNames , textDesc_objectid , textDesc_title , textDesc_credits , textDesc_description, iucnStatus , image_objectid , image_title, image_credits , image_fileName FROM Ttaxons WHERE taxonConceptId=?",[a],function(a,c){b(1===c.rows.length?c.rows.item(0):null)})},function(a, b){console.log(a)})},findAllByCollectionid:function(a,b){this.db.transaction(function(c){c.executeSql("SELECT fk_collectionid , pageid , taxonConceptId, taxonName , flathierarchy, preferredCommonNames , textDesc_objectid , textDesc_title , textDesc_credits , textDesc_description, iucnStatus , image_objectid , image_title, image_credits , image_fileName FROM Ttaxons WHERE ','||fk_collectionid||',' LIKE ?",["%,"+a+",%"],function(a,c){for(var h=c.rows.length,e=[],f=0;f<h;f+=1)e[f]=c.rows.item(f);b(e)})}, function(a,b){console.log(a)})},findAll:function(a){this.db.transaction(function(b){var c="SELECT fk_collectionid , pageid , taxonConceptId, taxonName , flathierarchy, preferredCommonNames , textDesc_objectid , textDesc_title , textDesc_credits , textDesc_description, iucnStatus , image_objectid , image_title, image_credits , image_fileName FROM Ttaxons LIMIT 10"+b.executeSql(c,[],function(b,c){for(var h=c.rows.length,e=[],f=0;f<h;f+=1)e[f]=c.rows.item(f);a(e)})},function(a,c){console.log(a)})},populate:function(a){directory.db.transaction(function(a){}, function(a,c){console.log(a)},function(b){a()})}}); _.extend(directory.dao.GalleryDAO.prototype,{updateGalleryActive:function(a,b){this.db.transaction(function(b){b.executeSql("UPDATE Tgallery SET active= ? WHERE collectionid = ? ",[a.get("active"),a.get("collectionid")])},function(a,b){console.log(a)})},findByName:function(a,b){this.db.transaction(function(c){c.executeSql("SELECT collectionid , name, description, logo, level, ordre, active FROM Tgallery WHERE name LIKE ?  LIMIT 20",["%"+a+"%"],function(a,c){for(var h=c.rows.length,e=[],f=0;f<h;f+= 1)e[f]=c.rows.item(f);b(e)})},function(a,b){console.log(a)})},findByGalleryId:function(a,b){this.db.transaction(function(c){c.executeSql("SELECT Tgallery_PK_Id, collectionid , name, description, logo, level, ordre, active FROM Tgallery WHERE collectionid = ? ",[a],function(a,c){b(1===c.rows.length?c.rows.item(0):null)})},function(a,b){console.log(a)})},findAll:function(a){this.db.transaction(function(b){b.executeSql("SELECT Tgallery_PK_Id, collectionid , name, description, logo,level , ordre, active FROM Tgallery ORDER BY level, ordre ", [],function(b,d){for(var g=d.rows.length,h=[],e=0;e<g;e+=1)h[e]=d.rows.item(e);a(h)})},function(a,c){console.log(a)})},populate:function(a){}}); _.extend(directory.dao.ItemDAO.prototype,{findByGalleryId:function(a,b){this.db.transaction(function(c){c.executeSql("SELECT *FROM Titems WHERE fk_collectionid = ? AND NOT INat = '' ",[a],function(a,c){for(var h=c.rows.length,e=[],f=0;f<h;f+=1)e[f]=c.rows.item(f);b(e)})},function(a,b){console.log(a)})},findAll:function(a){this.db.transaction(function(b){b.executeSql("SELECT * FROM Titems LIMIT 50",[],function(b,d){for(var g=d.rows.length,h=[],e=0;e<g;e+=1)h[e]=d.rows.item(e);a(h)})},function(a,c){console.log(a)})}, populate:function(a){}}); _.extend(directory.dao.ProfilDAO.prototype,{updatePseudoProfile:function(a,b){this.db.transaction(function(b){b.executeSql("UPDATE Tprofil SET pseudo= ? WHERE Tprofil_PK_Id = ? ",[a.get("pseudo"),a.get("Tprofil_PK_Id")])},function(a,b){console.log(a)})},findByPseudo:function(a,b){this.db.transaction(function(c){c.executeSql("SELECT * FROM Tprofil WHERE pseudo = ?  LIMIT 20",[a],function(a,c){for(var h=c.rows.length,e=[],f=0;f<h;f+=1)e[f]=c.rows.item(f);b(e)})},function(a,b){console.log(a)})},findById:function(a, b){this.db.transaction(function(c){c.executeSql("SELECT * FROM Tprofil WHERE Tprofil_PK_Id=?",[a],function(a,c){b(1===c.rows.length?c.rows.item(0):null)})},function(a,b){console.log(a)})},findAll:function(a){this.db.transaction(function(b){b.executeSql("SELECT * FROM Tprofil LIMIT 10",[],function(b,d){for(var g=d.rows.length,h=[],e=0;e<g;e+=1)h[e]=d.rows.item(e);a(h)})},function(a,c){console.log(a)})},populate:function(a){}}); _.extend(directory.dao.ScoreDAO.prototype,{createScore:function(a,b){this.db.transaction(function(b){b.executeSql("INSERT INTO  Tscore (fk_profil ,fk_gallery, gameDate , nbQuestionTotal, nbAnswerGood, nbAnswerGoodSequence, score)  VALUES (?, ?, ?, ?, ?, ?,?) ",[a.get("fk_profil"),a.get("fk_gallery"),a.get("gameDate"),a.get("nbQuestionTotal"),a.get("nbAnswerGood"),a.get("nbAnswerGoodSequence"),a.get("score")])},function(a,b){console.log(a)})},updateScore:function(a,b){this.db.transaction(function(b){b.executeSql("UPDATE Tscore SET * WHERE fk_gallery = ? ", [a.get("fk_gallery")])},function(a,b){console.log(a)})},findAllScoreByProfilId:function(a,b){this.db.transaction(function(c){c.executeSql("SELECT fk_gallery, MAX(score) AS score_max, gameDate FROM Tscore WHERE fk_profil = ? GROUP BY fk_gallery ",[a],function(a,c){for(var h=c.rows.length,e=[],f=0;f<h;f+=1)e[f]=c.rows.item(f);b(e)})},function(a,b){console.log(a)})},findScoreMaxByGallery:function(a){this.db.transaction(function(b){b.executeSql("SELECT fk_gallery, MAX(score) AS score_max FROM Tscore GROUP BY fk_gallery", [],function(b,d){for(var g=d.rows.length,h=[],e=0;e<g;e++)h[e]=d.rows.item(e);a(h)})},function(a,c){console.log(a)})},findScoreMaxByGalleryId:function(a,b){this.db.transaction(function(c){c.executeSql("SELECT MAX(score) AS score_max FROM Tscore WHERE fk_gallery = ?",[a],function(a,c){for(var h=c.rows.length,e=[],f=0;f<h;f++)e[f]=c.rows.item(f);b(e)})},function(a,b){console.log(a)})},findAll:function(a){this.db.transaction(function(b){b.executeSql("SELECT * FROM Tscore ORDER BY Tscore_PK_Id DESC", [],function(b,d){for(var g=d.rows.length,h=[],e=0;e<g;e+=1)h[e]=d.rows.item(e);a(h)})},function(a,c){console.log(a)})},destroy:function(a){this.db.transaction(function(b){b.executeSql("delete from Tscore",[],function(b,d){a()})},function(a,c){console.log(a)})},populate:function(a){}});var reponse=""; directory.models.Taxon=Backbone.Model.extend({defaults:{fk_collectionid:"",pageid:null,taxonConceptId:null,taxonName:"",flathierarchy:"",preferredCommonNames:"",textDesc_objectid:null,textDesc_title:"",textDesc_credits:"",textDesc_description:"",iucnStatus:"",image_objectid:null,image_title:"",image_credits:"",image_fileName:""},dao:directory.dao.TaxonDAO,parse:function(a){var b=eval(a.flathierarchy);a.flat=b;a.iucnPicture=this.switchIucnStatusDesc(a.iucnStatus);return a},initialize:function(){}, switchIucnStatusDesc:function(a){if("undefined"!=typeof a){switch(a){case "Least Concern (LC)":var b="Status_iucn3.1_LC.svg.png",c="Least Concern";break;case "Near Threatened (NT)":b="Status_iucn3.1_NT.svg.png";c="Near Threatened";break;case "Vulnerable (VU)":b="Status_iucn3.1_VU.svg.png";c="Vulnerable";break;case "Endangered (EN)":b="Status_iucn3.1_EN.svg.png";c="Endangered";break;case "Critically Endangered (CR)":case "Extinct in the Wild (EW)":b="Status_iucn3.1_EW.svg.png";c="Extinct in the wild"; break;case "Extinct (EX)":b="Status_iucn3.1_EX.svg.png",c="Extinct"}return[b,c]}}});directory.models.TaxonCollection=Backbone.Collection.extend({dao:directory.dao.TaxonDAO,model:directory.models.Taxon,initialize:function(){},findByName:function(a){var b=this;(new this.dao(directory.db)).findByName(a,function(a){b.reset(a)})},findAllByCollectionid:function(a){var b=this;(new this.dao(directory.db)).findAllByCollectionid(a,function(a){b.reset(a)})}}); directory.models.Gallery=Backbone.Model.extend({defaults:{Tgallery_PK_Id:null,collectionid:null,name:"",description:"",logo:"",level:0,ordre:0,active:!1},dao:directory.dao.GalleryDAO}); directory.models.GalleriesCollection=Backbone.Collection.extend({model:directory.models.Gallery,modelType:"GalleriesCollection",dao:directory.dao.GalleryDAO,initialize:function(){},findAll:function(a){var b=this;(new this.dao(directory.db)).findAll(function(a){b.reset(a)})},galleryIsActive:function(a){a=this.findWhere({ordre:a});if("undefined"!==typeof a)return a.get("active")},galleryOrdreById:function(a){a=this.findWhere({collectionid:a});if("undefined"!==typeof a)return a.get("ordre")},changeGalleryActivateState:function(a){if("true"!== this.galleryIsActive(a)&&"undefined"!==this.galleryIsActive(a)){var b=this.findWhere({ordre:a}).get("collectionid");this.findWhere({ordre:a}).set("id",b).set("active","true").save()}}});directory.models.Item=Backbone.Model.extend({defaults:{fk_collectionid:null,object_id:null,pageid:null,weightIucn:0,weightContinent:0,type:"",taxonConceptId:null,taxonName:"",preferredCommonNames:"",iNat:"",title:"",filename:""},dao:directory.dao.ItemDAO,parse:function(a){a.iNat=a.iNat.split(",");return a},initialize:function(){}}); directory.models.ItemsCollection=Backbone.Collection.extend({dao:directory.dao.ItemDAO,model:directory.models.Item,initialize:function(){},findAllByCollectionid:function(a){var b=this;a=parseInt(a);(new this.dao(directory.db)).findByGalleryId(a,function(a){b.reset(a)})}});directory.models.Profil=Backbone.Model.extend({defaults:{Tprofil_PK_Id:null,pseudo:"",avatar:"",email:"",creationDate:new Date},dao:directory.dao.ProfilDAO,initialize:function(){}}); directory.models.ProfilsCollection=Backbone.Collection.extend({dao:directory.dao.ProfilDAO,model:directory.models.Profil,initialize:function(){},findById:function(a){var b=this;(new this.dao(directory.db)).findById(a,function(a){b.reset(a)})},findByPseudo:function(a){var b=this;(new this.dao(directory.db)).findAllByCollectionid(a,function(a){b.reset(a)})}}); directory.models.Score=Backbone.Model.extend({defaults:{fk_profil:null,fk_gallery:0,gameDate:new Date,nbQuestionTotal:0,nbAnswerGood:0,nbAnswerGoodSequence:0,score:0,nbQuestionTotalAfrica:null,nbQuestionTotalAsia:null,nbQuestionTotalAntartica:null,nbQuestionTotalEurope:null,nbQuestionTotalOceania:null,nbQuestionTotalAmericaNorth:null,nbQuestionTotalAmericaSouth:null,nbAnswerGoodAfrica:null,nbAnswerGoodAsia:null,nbAnswerGoodAntartica:null,nbAnswerGoodEurope:null,nbAnswerGoodOceania:null,nbAnswerGoodAmericaNorth:null, nbAnswerGoodAmericaSouth:null},dao:directory.dao.ScoreDAO,initialize:function(){}}); directory.models.ScoresCollection=Backbone.Collection.extend({model:directory.models.Score,dao:directory.dao.ScoreDAO,initialize:function(){},findAllScoreByProfilId:function(a){var b=$.Deferred();(new this.dao(directory.db)).findAllScoreByProfilId(a,function(a){b.resolve(a)});return b},findScoreMaxByGallery:function(){var a=$.Deferred();(new this.dao(directory.db)).findScoreMaxByGallery(function(b){a.resolve(b)});return a},destroy:function(){var a=$.Deferred(),b=this;(new this.dao(directory.db)).destroy(function(c){a.resolve(c); b.reset()});return a}});Backbone.View.prototype.close=function(){var a=$.Deferred(),b=this,c=[];if(this.beforeClose)c.push(this.beforeClose());else{var d=$.Deferred();c.push(d);d.resolve(!0)}$.when.apply(null,c).done(function(){b.undelegateEvents();b.remove();b.unbind();a.resolve()}).fail(function(){a.reject()});return a.promise()}; directory.views.BaseView=Backbone.Layout.extend({prefix:directory.config.root+"/tpl/",fetch:function(a){a+=".html";directory.templates=directory.templates||{};if(directory.templates[a])return directory.templates[a];var b=this.async();$.get(a,function(c){b(directory.templates[a]=_.template(c))},"text")},serialize:function(){return this.model?this.model.toJSON():!0}});directory.views.HomeView=directory.views.BaseView.extend({template:"home-page",initialize:function(){}}); directory.views.SearchPage=Backbone.View.extend({tagName:"div",id:"searchPage",templateLoader:directory.utils.templateLoader,taxonsListView:directory.views.TaxonsListView,initialize:function(){this.model.findByName("Animalia");this.template=_.template(this.templateLoader.get("search-page"))},render:function(a){$(this.el).html(this.template(this.model.toJSON()));this.listView=new directory.views.TaxonsListView({el:$("ul",this.el),model:this.model});this.listView.render();return this},events:{"keyup .search-key":"search"}, search:function(a){a=$(".search-key").val();this.model.findByName(a)}});directory.views.TaxonsListView=Backbone.View.extend({initialize:function(){this.model.bind("reset",this.render,this)},render:function(a){$("#taxonList").empty();_.each(this.model.models,function(a){$("#taxonList").append((new directory.views.TaxonListItemView({model:a})).render().el)},this);return this}}); directory.views.TaxonListItemView=Backbone.View.extend({tagName:"li",DetailTaxonsView:directory.views.TaxonPanel,initialize:function(){this.template=_.template(directory.utils.templateLoader.get("taxon-list-item"))},render:function(a){$(this.el).html(this.template(this.model.toJSON()));return this},events:{"click div.taxon-list-item":"loadTaxonDetail"},loadTaxonDetail:function(a){a=a.currentTarget.id;(new directory.models.Taxon({id:a,taxonConceptId:a})).fetch({success:function(a){$("#panel_taxon-detail").empty(); $("#panel_taxon-detail").append((new directory.views.TaxonPanel({model:a})).render().el)}})}}); directory.views.TaxonPanel=Backbone.View.extend({initialize:function(){this.template=_.template(directory.utils.templateLoader.get("taxon-panel"))},render:function(a){$(this.el).html(this.template(this.model.toJSON()));return this},events:{"click div.accordion-heading":"changeIcon","click .moreInfo":"tooltipIucn"},changeIcon:function(a){$(".accordion-group").on("hide",function(){$(this).children().children().children("i").removeClass("icon-minus");$(this).children().children().children("i").addClass("icon-plus")}); $(".accordion-group").on("show",function(){$(this).children().children().children("i").removeClass("icon-plus");$(this).children().children().children("i").addClass("icon-minus")})},tooltipIucn:function(a){document.documentElement.hasOwnProperty("ontouchstart")&&(a=$(".moreInfo").find(".title"),a.length?a.remove():$(".moreInfo").append('<span class="title">'+$(".moreInfo").attr("title")+"</span>"))}}); directory.views.GalleryListView=Backbone.View.extend({tagName:"div",id:"gallery-list-page",templateLoader:directory.utils.templateLoader,initialize:function(){this.model.findAll();this.model.bind("reset",this.render,this);this.template=_.template(this.templateLoader.get("gallery-page"))},render:function(a){$(this.el).html(this.template());_.each(this.model.models,function(a){$("#gallery-list",this.el).append((new directory.views.GalleryListItemView({model:a})).render().el)},this);return this},events:{"click #descCollBtn":"showdescCollModal"}, showdescCollModal:function(a){$("#descCollModal").modal("toggle")}}); directory.views.playListGalleryView=Backbone.View.extend({tagName:"div",id:"play-list-gallery-page",templateLoader:directory.utils.templateLoader,initialize:function(){this.collection.bind("reset",this.render,this);this.currentProfil=this.options.currentProfil;this.template=_.template(this.templateLoader.get("play-gallery"))},render:function(a){$(this.el).html(this.template({collection:this.collection}));return this},events:{"click #descPlayBtn":"showdescPlayModal","click .close":"hide","click .closeButton":"hide", "click #dontShowMsg":"dontShowDescPlayModalAgain"},showdescPlayModal:function(a){$("#descPLayModal").modal("toggle")},dontShowDescPlayModalAgain:function(a){dontShowModal="hide"},hide:function(a){$("#descPLayModal").modal("show").hide()}});directory.views.GalleryListItemView=Backbone.View.extend({tagName:"li",initialize:function(){this.template=_.template(directory.utils.templateLoader.get("gallery-list-item"))},render:function(a){$(this.el).html(this.template(this.model.toJSON()));return this}}); directory.views.GalleryDetailView=Backbone.View.extend({tagName:"div",id:"collection-detail",initialize:function(){this.template=_.template(directory.utils.templateLoader.get("gallery-detail"))},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},onAddToDom:function(){this.graphView=new directory.views.D3GraphPanelView({model:this.model});$("#search-taxon-content",this.el).append(this.graphView.render().el);this.graphView.onAddToDom()}}); directory.views.D3GraphPanelView=Backbone.View.extend({tagName:"div",id:"d3-graph-panel",initialize:function(){this.template=_.template(directory.utils.templateLoader.get("d3-graph-panel"))},render:function(){this.$el.html(this.template(this.model.toJSON()));$("#panel_taxon-detail",this.el).append((new directory.views.GalleryPanel({model:this.model})).render().el);return this},onAddToDom:function(){this.graph=new MeolGraph("meolGraphContainer",{dataSource:"data/hierarchies/"+this.model.get("collectionid")+ ".json",canvasWidth:widthScreen,canvasHeight:heightScreen,charge:-1200,distance:100,nodeBoxWidth:110,nodeBoxRx:10,nodeNonLeafHeight:30,nodeLeafHeight:90,nodeLabelXOffset:10,nodeLabelYLeafOffset:12,nodeLabel2YLeafOffset:24,nodeLabelYNonLeafOffset:17,nodeExpandCircleXOffset:92,nodeExpandCircleYOffset:15,nodeExpandCircleR:10,nodeImageWidth:104,nodeImageHeight:67,nodeImageXOffset:3,nodeImageLeafYOffset:3})},events:{"click #collapseAll":"collapseAll","click #expandAll":"expandAll","click .collectionName h1":"displayPanelCollection"}, collapseAll:function(a){"undefined"!=typeof this.graph&&(this.graph._collapseAllNodes(),$("#panel_taxon-detail").empty(),$("#panel_taxon-detail",this.el).append((new directory.views.GalleryPanel({model:this.model})).render().el))},expandAll:function(a){"undefined"!=typeof this.graph&&this.graph._expandAllNodes()},displayPanelCollection:function(a){"undefined"!=typeof this.graph&&($("#panel_taxon-detail").empty(),$("#panel_taxon-detail",this.el).append((new directory.views.GalleryPanel({model:this.model})).render().el))}}); directory.views.GalleryPanel=Backbone.View.extend({initialize:function(){this.template=_.template(directory.utils.templateLoader.get("gallery-panel"))},render:function(a){$(this.el).html(this.template(this.model.toJSON()));return this}}); directory.views.GalleryTaxonList=Backbone.View.extend({el:"div",templateLoader:directory.utils.templateLoader,GalleryItemListView:directory.views.GalleryItemListView,initialize:function(){this.template=_.template(this.templateLoader.get("gallery-taxon-list"))},render:function(a){$(this.el).html(this.template(this.model.toJSON()));this.listView=new directory.views.GalleryItemListView({el:$("div",this.el),model:this.model});this.listView.render();return this}}); directory.views.playGameboardView=Backbone.View.extend({template:"play-gameboard",templateLoader:directory.utils.templateLoader,itemsCollection:directory.models.ItemsCollection,currentScoreGame:directory.models.Score,tagName:"div",id:"play-gameboard",initialize:function(){this.itemsCollection=new directory.models.ItemsCollection;var a=this.model.get("collectionid"),b=this.model.get("ordre")+1;this.nextGalleryActive=directory.data.galleriesList.galleryIsActive(b);"undefined"!==typeof this.options.lastScoreByGallery? this.lastScoreByGallery=this.options.lastScoreByGallery:(this.lastScoreByGallery=new directory.models.ScoresCollection,this.lastScoreByGallery.score=0);this.scoreByfk_profil="undefined"!==typeof this.options.scoreByfk_profil?this.options.scoreByfk_profil:new directory.models.ScoresCollection;this.ScoreGlobal=this.options.ScoreGlobal;this.itemsCollection.findAllByCollectionid(a);this.currentProfil=this.options.currentProfil;this.currentScoreGame=new directory.models.Score({fk_profil:this.currentProfil.get("Tprofil_PK_Id"), fk_gallery:a});this.template=_.template(this.templateLoader.get("play-gameboard"));this.model.bind("change",this.saveScore,this)},render:function(){this.$el.html(this.template({gallery:this.model.toJSON(),profil:this.currentProfil.toJSON(),score:this.lastScoreByGallery.toJSON(),allScore:this.ScoreGlobal}));$("#map",this.$el).load("css/map/map_EOL.svg");return this},events:{"click #selectRandomContinent":"selectRandomContinent","change #currentContinent":"loadTaxonPlay","change #scoreTotalValue":"updateScore", "change #nbAnwserGoodValue":"updateNbAnwserGood","change #nbAnwserGoodSequenceValue":"updateNbAnwserGoodSequenceValue","click #returnToGame":"returnToGame","click #navigateNewGallery":"navigateNewGallery","click #ruleBtn":"toggleRulesModal","click .gameQuit":"showGameQuitModal"},beforeClose:function(){this.saveScore()},navigateNewGallery:function(){this.beforeClose();var a=new directory.Router,b=this.model.get("ordre")+1,b=directory.data.galleriesList.findWhere({ordre:b}).get("collectionid");a.navigate("play/"+ b,{trigger:!0,replace:!0})},returnToGame:function(a){d3.select("#gameDetailPanel").classed("hidden",!0);d3.select("#gamePanel").classed("hidden",!1)},selectRandomContinent:function(a){function b(){var a=0,b=200,d;for(d in c)d3.select(c[d]).transition().delay(a).style("fill","#B9DE00"),d3.select(c[d]).transition().delay(b).style("fill","#E1FA9F"),a+=150,b+=200}$("#rulesModal").modal("hide");d3.select("#map svg").selectAll(".pion").classed("hideInfoContinent",!0);d3.select("#selectRandomContinent").classed("hidden", !0);$("#firstMessagePlay").css("display","none");$("#continentName").css("display","inherit");a=d3.select("#map svg").selectAll(".continent");a=a[Math.floor(Math.random()*a.length)];var c=shuffleContinent(a);for(a=0;1>a;)b(),a++;a=c[2];var d=$("#currentContinent").val(),g=a.id;"america-south"===g&&(g="south america");"america-north"===g&&(g="North America");"undefined"!==typeof d&&g.toLowerCase()==d.toLowerCase()&&(a=c[3]);d3.selectAll(".continent").transition().delay(1600).style("fill","#E1FA9F"); d3.select(a).transition().delay(1600).style("fill","#B9DE00");var h=a.id;setTimeout(function(){d3.select("."+h).classed("hideInfoContinent",!1)},1800);$("#requestPanel").hide();d=a.id;"america-south"===d&&(d="South America");"america-north"===d&&(d="North America");$(".txtCurrentContinent").html(d);$("#currentContinent").val(d).trigger("change");$("#myModal").modal("hide")},saveScore:function(){var a=parseInt($("#scoreTotalValue").val());0<a&&this.currentScoreGame.set("score",a).set("fk_gallery", this.model.get("collectionid")).save()},updateScore:function(a){a=parseInt($("#scoreTotalValue").val());var b=a/200;$("#meterScore").css("width");this.model.get("ordre");var c=this.model.get("ordre")+1;"true"!==directory.data.galleriesList.galleryIsActive(c)?100<=parseInt(b)?(parseInt(c)<=parseInt(directory.data.galleriesList.length)&&(this.nextCollectionName=directory.data.galleriesList.findWhere({ordre:c}).get("name"),directory.data.galleriesList.changeGalleryActivateState(c),setTimeout(function(){$("#collectionModal").fadeIn(1E3).show(100).alert()}, 1E3),setTimeout(function(){$("#collectionModal").animate({top:"0",left:"+=8%",zIndex:"1",width:"-=100px",height:"-=110px",right:"120px",margin:"0px"},500)},3400),setTimeout(function(){$("#collectionModal.alert h4").animate({fontSize:"16px",lineHeight:"20px"},500)},3400),setTimeout(function(){$("#collectionModal.alert button").animate({fontSize:"14px",padding:"0px"},500)},3400),this.currentScoreGame.set("score",a)),setTimeout(function(){$(".progress").fadeIn(1E3).css("box-shadow","0px 0px 10px 4px #E2E9EF")}, 3400),$("#meterScore").css("width",b+"%"),setTimeout(function(){$("#meterScore").fadeIn(1E3).css("width","100%")},3E3),setTimeout(function(){$(".progress").fadeIn(1E3).css("box-shadow","0px 0px 0px 0px #E2E9EF")},3E3)):$("#meterScore").css("width",b+"%"):$("#meterScore").fadeIn(1E3).css("width","100%");this.currentScoreGame.set("score",a);$("#activateCollMessageModal").html("<em>New unlocked collection:<br/>"+this.nextCollectionName+"</em>")},updateNbAnwserGood:function(a){$("#nbAnwserGoodText").html($("#nbAnwserGoodValue").val()); a=parseInt($("#nbAnwserGoodValue").val());this.currentScoreGame.set("nbAnswerGood",a)},updateNbAnwserGoodSequenceValue:function(a){$("#bonusValue").val("0");this.model.get("ordre");a=parseInt($("#scoreTotalValue").val());$("#nbAnwserGoodSequenceText").html($("#nbAnwserGoodSequenceValue").val());var b=$("#nbAnwserGoodSequenceValue").val(),c=$("#nbAnwserGoodSequenceRecordText").text(),d=fiboSuite();parseInt(b)>parseInt(c)&&($("#nbAnwserGoodSequenceRecordText").html($("#nbAnwserGoodSequenceValue").val()), b=parseInt($("#nbAnwserGoodSequenceValue").val()),d=d(b),d=2>d?0:100*d,$("#bonusValue").val(d).trigger("change"),$("#bonus").html($("#bonusValue").val()),d=this.currentScoreGame.get("nbAnswerGoodSequence"),this.currentScoreGame.set("nbAnswerGoodSequence",d+1));d=parseInt($("#bonusValue").val());a+=d;0<a&&($("#scoreTotalValue").val(a).trigger("change"),$("#scoreText").html(a));if(0===a||a>parseInt(this.lastScoreByGallery.score)||a>parseInt(this.lastScoreByGallery.get("score")))b=a+this.ScoreGlobal, $("#allScore").html(b);parseInt(this.lastScoreByGallery.get("score"))>this.ScoreGlobal&&(b=a,$("#allScore").html(b));a>this.ScoreGlobal&&(b=a,$("#allScore").html(b));0<d&&($("#bonus").fadeIn(1E3).css("box-shadow","0px 0px 12px 6px #E2E9EF"),setTimeout(function(){$("#bonus").fadeIn(3E3).css("box-shadow","0px 0px 0px 0px #E2E9EF")},2400),$("#bonusMessageModal").html("+"+d+" Bonus series points"))},loadTaxonPlay:function(a){a=this.currentScoreGame.get("nbQuestionTotal");this.currentScoreGame.set("nbQuestionTotal", a+1);a=$("#currentContinent").val();var b=new directory.models.ItemsCollection,c=Math.floor(Math.random()*this.itemsCollection.models.length),d=this.itemsCollection.models[c].attributes.iNat.split(","),g=capitaliseFirstLetter(a),h=0;if("undefined"!==typeof a){for(var e in d){if(16<h||g==d[e]||"undefined"===typeof d[e])break;if("undefined"!=typeof d[e]){for(;g!=d[e]&&!(16<h);)c=Math.floor(Math.random()*this.itemsCollection.models.length),d=this.itemsCollection.models[c].attributes.iNat.split(","), h+=1;b.models[0]=this.itemsCollection.models[c]}}b.models[0]=this.itemsCollection.models[c]}for(e=Math.floor(Math.random()*this.itemsCollection.models.length);e==c;)e=Math.floor(Math.random()*this.itemsCollection.models.length);b.models[1]=this.itemsCollection.models[e];for(d=Math.floor(Math.random()*this.itemsCollection.models.length);d==c||d==e;)d=Math.floor(Math.random()*this.itemsCollection.models.length);b.models[2]=this.itemsCollection.models[d];b.models=shuffle(b.models);c=new directory.models.Item; c.set("filename","unknown_taxon.jpg");c.set("Titem_PK_Id","-1");c.set("preferredCommonNames","None of these live here");b.models[3]=c;"undefined"!==typeof this.listView&&this.listView.remove();this.listView=new directory.views.RandomItemListView({model:b});this.listView.gallery=this.model;this.listView.render();$("#taxonSelectList",this.el).append(this.listView.el);$("#requestPanel").delay(2200).slideDown("slow");$(".playableTaxonHidden").hide();$(".txtCurrentContinent").html(a);return this},toggleRulesModal:function(a){$("#rulesModal").modal("toggle")}, showGameQuitModal:function(a){var b=this;$("#myModal").modal("hide");var c=new directory.Router,d=a.currentTarget.id;$("#gameQuitModal").modal("show");$("#gameQuitValidate").click(function(){b.beforeClose();c.navigate("#"+d,{trigger:!0,replace:!0})})}}); directory.views.RandomItemListView=Backbone.View.extend({tagName:"div",gallery:directory.models.Gallery,initialize:function(){this.template=_.template(directory.utils.templateLoader.get("request-panel"));this.model.bind("reset",this.render,this)},render:function(a){this.$el.html(this.template(this.model.toJSON()));return this},events:{"click .playableTaxon img":"expandItemSticker","click .playableTaxonValidate":"validateItem","click .playableTaxonDetail":"showGraph"},showGraph:function(a){d3.select("#gameDetailPanel").classed("hidden", !1);d3.select("#gamePanel").classed("hidden",!0);a=parseInt(a.currentTarget.id.replace("detailTaxon-",""));"undefined"===typeof this.graphView?($("#graph-panel").empty(),this.graphView=new directory.views.D3GraphPanelView({model:this.gallery}),$("#graph-panel").append(this.graphView.render().el),this.graphView.onAddToDom()):this.graphView.graph.refreshCurrentNode(this.model.models[a].get("taxonConceptId"));this.graphView.graph.displayPanel(this.model.models[a].get("taxonConceptId"),this.model.models[a].attributes.filename)}, expandItemSticker:function(a){},validateItem:function(a){$("#rulesModal").modal("hide");$("#scoreMessageModal").empty();$("#bonusMessageModal").empty();$("#reponseMessageModal").empty();$("#activateCollMessageModal").empty();$("#myModal h5").remove();var b=parseInt(a.currentTarget.id.replace("validate-","")),c=this.model.models[b].attributes.Titem_PK_Id;$("#item-"+c).removeClass("gradientGrey");$("#item-"+c).addClass("gameFalseSelectedItem");var d=$("#currentContinent").val(),g=a=0,h=[],e=!1,f;for(f in this.model.models){h[f]= !1;var l=this.model.models[f].attributes.iNat.split(","),m;for(m in l)d.toLowerCase()==l[m].toLowerCase()&&(e=h[f]=!0,$("#item-"+this.model.models[f].attributes.Titem_PK_Id).removeClass("gradientGrey"),$("#item-"+this.model.models[f].attributes.Titem_PK_Id).addClass("gameTrueSelectedItem"),$("#reponseMessageModal").append("<li>"+this.model.models[f].attributes.preferredCommonNames+"</li>"),g=this.model.models[f],a=g.get("weightIucn"),g=g.attributes.weightContinent)}m=!1;d=[];for(l=0;l<h.length;l++)!0== h[l]&&d.push(l);if("undefined"!==typeof d){var k=d.length;1<k?(k*=50,$("#reponseMessageModal").before("<h5>Correct answers were...</h5>")):(k=0,$("#reponseMessageModal").before("<h5>The correct answer was...</h5>"))}if(!0==h[b]||-1==c&&!1==e)$("#item-"+c).removeClass("gradientGrey"),$("#item-"+c).addClass("gameTrueSelectedItem"),m=!0;-1==c&&!1==e&&$("#reponseMessageModal").append("<li>"+this.model.models[f].attributes.preferredCommonNames+"</li>");!1==m?(e||($("#item--1").removeClass("gradientGrey"), $("#item--1").addClass("gameTrueSelectedItem "),$("#reponseMessageModal").append("<li>"+this.model.models[f].attributes.preferredCommonNames+"</li>")),a=parseInt($("#scoreTotalValue").val()),$("#scoreTotalValue").val(a+0).trigger("change"),a=parseInt($("#nbAnwserGoodValue").val()),$("#nbAnwserGoodValue").val(a+0).trigger("change"),$("#myModal").removeAttr("style"),$("#nbAnwserGoodSequenceValue").val(0).trigger("change"),$("#txtMessageModal").html("<span id ='sorry'>Sorry!</span>")):(f=1<g?10*g:0, b=1<a?10*a:0,a=parseInt($("#scoreTotalValue").val()),k=k+f+b,$("#scoreTotalValue").val(a+1E3-k).trigger("change"),a=parseInt($("#nbAnwserGoodValue").val()),$("#nbAnwserGoodValue").val(a+1).trigger("change"),a=parseInt($("#nbAnwserGoodSequenceValue").val()),$("#nbAnwserGoodSequenceValue").val(a+1).trigger("change"),$("#myModal").css("box-shadow","0px 0px 25px 10px white"),$("#txtMessageModal").html("Well Done!"),$("#myModal h5").remove(),$("#reponseMessageModal").html(""),$("#scoreMessageModal").html(1E3- k+" points"));d3.select("#selectRandomContinent").classed("hidden",!1);$("#myModal").modal("show");$(".playableTaxonValidate").addClass("disabled")}}); directory.views.ProfilDetailView=directory.views.BaseView.extend({template:"profil-page",initialize:function(){},beforeRender:function(){var a=new directory.models.ScoresCollection,b=this;a.findAllScoreByProfilId(this.model.get("Tprofil_PK_Id")).done(function(c){var d=0,g=1;_.each(c,function(a){var b=directory.data.galleriesList.galleryOrdreById(String(a.fk_gallery));b>g&&(g=b);d+=a.score_max});a.reset(c);c=directory.data.galleriesList.findWhere({ordre:parseInt(g)}).get("name");b.insertView("#profileTable", new directory.views.TableProfilDetailView({collection:a,model:b.model,lastActiveGalleryName:c,scoreTotal:d})).render()})},serialize:function(){return{model:this.model}},events:{"click #pseudo":"showModalPseudo","click #profileSubmitModal":"profileSubmitModal"},showModalPseudo:function(a){$("#profileModal").modal("show")},profileSubmitModal:function(a){a=$("input#profileTextModal").val();console.log(typeof a);""!==a&&($("#pseudo").html(a),this.model.set("Tprofil_PK_Id",parseInt(this.model.get("Tprofil_PK_Id"))).set("pseudo", String(a)).save())}}); directory.views.TableProfilDetailView=directory.views.BaseView.extend({template:"profil-table",initialize:function(){this.scoreTotal=this.options.scoreTotal;this.lastActiveGalleryName=this.options.lastActiveGalleryName;this.model.bind("reset",this.render,this);this.collection.bind("reset",this.render,this);this.collection.bind("reset",this.msgReset,this)},events:{"click #btnModalReset":"showModalReset","click #btnResetScore":"destroyTScore","click .closeButton":"msgReset"},serialize:function(){return{collection:this.collection,scoreTotal:this.scoreTotal, lastActiveGalleryName:this.lastActiveGalleryName}},destroyTScore:function(a){this.collection.destroy();this.scoreTotal=0;this.lastActiveGalleryName=directory.data.galleriesList.findWhere({ordre:1}).get("name")},showModalReset:function(a){$("#resetModal").modal("show")},msgReset:function(){$("#resetModal").modal("hide")}});directory.views.feedbackView=directory.views.BaseView.extend({template:"feedback-page"});directory.views.creditPageView=directory.views.BaseView.extend({template:"credit-page"}); var MeolGraph=function(a,b){this.containerId=document.getElementById(a);this.svgcontainerId=b.svgcontainerId||"meol-graph";this.dataSource=b.dataSource;this.canvasWidth=b.canvasWidth||heightScreen;this.canvasHeight=b.canvasHeight||widthScreen;this.charge=b.charge||-1200;this.distance=b.distance||100;this.nodeBoxRx=b.nodeBoxRx||10;this.nodeBoxRy=b.nodeBoxRy||10;this.nodeBoxWidth=b.nodeBoxWidth||110;this.nodeNonLeafHeight=b.nodeNonLeafHeight||30;this.nodeLeafHeight=b.nodeLeafHeight||90;this.nodeLabelXOffset= b.nodeLabelXOffset||10;this.nodeLabel2YLeafOffset=b.nodeLabel2YLeafOffset||24;this.nodeLabelYLeafOffset=b.nodeLabelYLeafOffset||12;this.nodeLabelYNonLeafOffset=b.nodeLabelYNonLeafOffset||17;this.nodeExpandCircleXOffset=b.nodeExpandCircleXOffset||92;this.nodeExpandCircleYOffset=b.nodeExpandCircleYOffset||15;this.nodeExpandCircleR=b.nodeExpandCircleR||10;this.nodeImageWidth=b.nodeImageWidth||104;this.nodeImageHeight=b.nodeImageHeight||67;this.nodeImageXOffset=b.nodeImageXOffset||3;this.nodeImageLeafYOffset= b.nodeImageLeafYOffset||3;this.nodeTextHeight=b.nodeTextHeight||10;this.charaterSplitNb=b.charaterSplitNb||18;this.currentNode=b.currentNode||null;this.init()}; MeolGraph.prototype.init=function(){var a=this;this.vis=d3.select(this.containerId).append("svg:svg").call(d3.behavior.zoom().on("zoom",function(){a.vis.attr("transform","translate("+d3.event.translate+") scale("+d3.event.scale+")")})).attr("width",this.canvasWidth).attr("height",this.canvasHeight).attr("id",this.svgcontainerId).append("svg:g");this.force=d3.layout.force().on("tick",function(){a.link.attr("x1",function(a){return a.source.x+55}).attr("y1",function(b){return b.source.y+a._computeNodeHeight(b.source)/ 2}).attr("x2",function(a){return a.target.x+55}).attr("y2",function(b){return b.target.y+a._computeNodeHeight(b.target)/2});a.graphNodes.attr("x",function(a){return a.x}).attr("y",function(a){return a.y})}).size([this.canvasWidth,this.canvasHeight]);d3.json(this.dataSource,function(b){a.root=b;a.root._children=a.root.children;a.root.leaves=a._getLeaves(a.root);a.root.children=a.root.leaves;a._update()})}; MeolGraph.prototype._update=function(){var a=this;this.dataNodes=this._flatten(this.root);this.links=d3.layout.tree().links(this.dataNodes);this.link=this.vis.selectAll("line.link").data(this.links,function(a){return a.target.id});this.link.enter().insert("svg:line",".node").attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}).attr("class","link");this.link.exit().remove();this.force.nodes(this.dataNodes).links(this.links).charge(this.charge).distance(this.distance).start(); this.graphNodes=this.vis.selectAll("svg.node").data(this.dataNodes,function(a){return a.id});this.node=this.graphNodes.enter().append("svg:svg").attr("class","node").attr("id",function(a){return a.taxonConceptID}).attr("x",function(a){return a.x}).attr("y",function(a){return a.y});this.node.filter(function(a,b){return"undefined"!==typeof a.image&1}).call(this.force.drag);var b="click";document.documentElement.hasOwnProperty("ontouchstart")&&(b="touchstart");this.node.on(b,function(b,d){var g;if("undefined"!== typeof b.taxonConceptID){var h=b.taxonConceptID;g=new directory.models.Taxon({id:h,taxonConceptId:h});g.fetch({add:!0,success:function(d){$("#meolGraphContainer svg#"+a.currentNode+" rect").attr("class","child");$("rect").attr("style","");$("#meolGraphContainer svg#"+b.taxonConceptID+" rect").attr("style","fill: #B9DE00;");a.currentNode=b.taxonConceptID;"undefined"!==typeof b.image&&g.set("image_fileName",b.image);$("#panel_taxon-detail").empty();$("#panel_taxon-detail").append((new directory.views.TaxonPanel({model:d})).render().el)}})}b.terminal&& !0!=a._isPenultimate(b)||(b.expanded&&!1==a._isPenultimate(b)?(a._collapseNode(b),$.each(b._children,function(b,c){a._collapseNode(c);a._markChildrenAsNotExpanded(c)})):a._expandNode(b),a.graphNodes.selectAll("text.expand-icon").text(function(b){var c=a._isPenultimate(b);return b.expanded||c?c?"":"-":"+"}))});this.node.append("svg:rect").attr("height",function(b){return a._computeNodeHeight(b)}).attr("width",this.nodeBoxWidth).attr("class","child").attr("rx",this.nodeBoxRx).attr("ry",this.nodeBoxRY).attr("id", function(a){return 0==a.depth||-1==a.depth?"root":""});b=this.node.append("svg:text").attr("x",a.nodeLabelXOffset).attr("y",function(b){return a.nodeLabelYLeafOffset}).attr("class",function(a){return"undefined"===typeof a.terminal?"common-name intermediary":"common-name terminal"});b.append("svg:tspan").attr("x",a.nodeLabelXOffset).attr("dy",0).text(function(a){return"undefined"===typeof a.splitVernacularName?"":a.splitVernacularName[0]});b.append("svg:tspan").attr("x",a.nodeLabelXOffset).attr("dy", a.nodeTextHeight).text(function(a){return"undefined"===typeof a.splitVernacularName?"":"undefined"===typeof a.splitVernacularName[1]?"":a.splitVernacularName[1]});b.append("svg:tspan").attr("x",a.nodeLabelXOffset).attr("dy",a.nodeTextHeight).text(function(a){return"undefined"===typeof a.splitVernacularName?"":"undefined"===typeof a.splitVernacularName[2]?"":a.splitVernacularName[2]});b=this.node.append("svg:text").attr("x",a.nodeLabelXOffset).attr("y",function(b){return"undefined"===typeof b.vernacularName? a.nodeLabelYLeafOffset:a.nodeLabelYLeafOffset+10*b.vernacularLineNb}).attr("class","scientific-name");b.append("svg:tspan").attr("x",a.nodeLabelXOffset).attr("dy",0).text(function(a){return a.splitName[0]});b.append("svg:tspan").attr("x",a.nodeLabelXOffset).attr("dy",a.nodeTextHeight).text(function(a){return"undefined"===typeof a.splitName[1]?"":a.splitName[1]});b.append("svg:tspan").attr("x",a.nodeLabelXOffset).attr("dy",a.nodeTextHeight).text(function(a){return"undefined"===typeof a.splitName[2]? "":a.splitName[2]});this.node.filter(function(a,b){return!0!=a.terminal&1}).append("svg:circle").attr("cx",a.nodeExpandCircleXOffset).attr("cy",a.nodeExpandCircleYOffset).attr("r",a.nodeExpandCircleR).attr("class","expand-icon-circle").attr("fill-opacity",function(b){return"undefined"!==typeof b.terminal||a._isPenultimate(b)&&0!=b.depth?0:1});this.node.filter(function(a,b){return!0!=a.terminal&1}).append("svg:text").attr("x",a.nodeExpandCircleXOffset-4).attr("y",a.nodeLabelYNonLeafOffset+1).attr("class", "expand-icon").attr("fill","white").text(function(a){return 0==a.depth?"+":""});this.node.filter(function(a,b){return"undefined"!==typeof a.image&1}).append("svg:image").attr("xlink:href",function(a){return"undefined"!==typeof a.image?"data/images_taxon/"+a.image:""}).attr("x",a.nodeImageXOffset).attr("y",function(b){return 30+(b.vernacularLineNb-1)*a.nodeTextHeight+(b.scientificLineNb-1)*a.nodeTextHeight}).attr("width",a.nodeImageWidth).attr("height",a.nodeImageHeight);this.graphNodes.exit().remove()}; MeolGraph.prototype._computeNodeHeight=function(a){var b=this.nodeNonLeafHeight,c=this.nodeLabel2YLeafOffset;if("undefined"===typeof a.splitName){var d=this._splitText2Tspan(a.name,this.charaterSplitNb);a.splitName=d;a.scientificLineNb=a.splitName.length}"undefined"!==typeof a.vernacularName&&"undefined"===typeof a.splitVernacularName&&(d=this._splitText2Tspan(a.vernacularName,this.charaterSplitNb),a.splitVernacularName=d,a.vernacularLineNb=a.splitVernacularName.length);"undefined"===typeof a.vernacularLineNb&& (a.vernacularLineNb=0);!0==a.terminal?b=this.nodeLeafHeight:c=0;b=b+(a.scientificLineNb-1)*this.nodeTextHeight+(a.vernacularLineNb-1)*this.nodeTextHeight;b<this.nodeNonLeafHeight&&(b=this.nodeNonLeafHeight);return"undefined"===typeof a.name?b:b+c};MeolGraph.prototype.refreshCurrentNode=function(a){this.currentNode=a;this._update()}; MeolGraph.prototype.displayPanel=function(a,b){var c=new directory.models.Taxon({id:a,taxonConceptId:a});c.fetch({add:!0,success:function(d){$("#meolGraphContainer svg#"+a+" rect").attr("class","child");$("rect").attr("style","");$("#meolGraphContainer svg#"+a+" rect").attr("style","fill: #B9DE00;");"undefined"!==typeof b&&c.set("image_fileName",b);$("#panel_taxon-detail").empty();$("#panel_taxon-detail").append((new directory.views.TaxonPanel({model:d})).render().el)}})}; d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};MeolGraph.prototype.changeCurrentNode=function(a){this.currentNode=a;this._update()};MeolGraph.prototype._flatten=function(a){function b(a){a.children&&a.children.forEach(b);c.push(a)}var c=[];b(a);return c};MeolGraph.prototype._markChildrenAsNotExpanded=function(a){function b(a){a._children&&a._children.forEach(b);a.expanded=!1}b(a)}; MeolGraph.prototype._getLeaves=function(a){function b(a){a.children?a.children.forEach(b):c.push(a)}var c=[];a.terminal||b(a);return c};MeolGraph.prototype._isPenultimate=function(a){var b=!0;a._children&&a._children.forEach(function(a){a.terminal||(b=!1)});return b};MeolGraph.prototype._updateAllExpandCollapseIcone=function(){var a=this;a.graphNodes.selectAll("text.expand-icon").text(function(b){var c=a._isPenultimate(b);return b.expanded||c?c?"":"-":"+"})}; MeolGraph.prototype._collapseNode=function(a){a.terminal||(a.children=a.leaves,a.expanded=!1,this._update())};MeolGraph.prototype._expandNode=function(a){var b=this;if(!a.terminal){var c=[];$.each(a._children,function(a,g){g.hasBeenExpanded||(g.leaves=b._getLeaves(g),g._children=g.children,g.hasBeenExpanded=!0);g.children=g.leaves;c.push(g)});a.children=c;a.expanded=!0;a.hasBeenExpanded=!0;this._update()}}; MeolGraph.prototype._expandAllNodes=function(a){function b(a){if(!a.terminal){var g=[];$.each(a._children,function(a,b){b.hasBeenExpanded||(b.leaves=c._getLeaves(b),b._children=b.children,b.hasBeenExpanded=!0);b.children=b.leaves;g.push(b)});a.children=g;a.expanded=!0;a.hasBeenExpanded=!0;a.children&&a.children.forEach(b)}}a||(a=this.root);var c=this;b(a);c.currentNode=null;this._update();this._updateAllExpandCollapseIcone()}; MeolGraph.prototype._collapseAllNodes=function(a){function b(a){a.terminal||(a.children=a.leaves,a.expanded=!1);a.children&&a.children.forEach(b)}a||(a=this.root);b(a);this.currentNode=null;this._update();this._updateAllExpandCollapseIcone();this.vis.attr("transform","translate(0,0) scale(1)")};MeolGraph.prototype._splitText2Tspan=function(a,b){for(var c=[],d="",g=0,h=0,e=a.split(" "),f=0;f<e.length;f++)h+=e[f].length,h>b?(c[g]=trim(d),h=e[f].length,g+=1,d=e[f]+" "):d+=e[f]+" ";c[g]=d;return c}; function trim(a){return a.replace(/^\s+/g,"").replace(/\s+$/g,"")} directory.Router=Backbone.Router.extend({routes:{"":"home",searchtaxon:"searchtaxon",creditPage:"creditPage",gallery:"discoverGalleryList","gallery/:galleryId":"discoverGalleryTaxonomicTreeView",play:"playListGallery","play/:galleryId":"playGameboardDisplay","profil/:profilId":"profilDisplay",feedback:"feedbackDisplay"},initialize:function(){var a=this;this.pageHistory=[];$("#content").on("click",".header-back-button",function(a){window.history.back();return!1});document.documentElement.hasOwnProperty("ontouchstart")? ($("#content").on("touchstart","a",function(b){a.selectItem(b)}),$("#content").on("touchend","a",function(b){a.deselectItem(b)})):($("#content").on("mousedown","a",function(b){a.selectItem(b)}),$("#content").on("mouseup","a",function(b){a.deselectItem(b)}));this.currentProfil=new directory.models.Profil({Tprofil_PK_Id:1});this.currentProfil.fetch()},selectItem:function(a){$(a.target).addClass("tappable-active")},deselectItem:function(a){$(a.target).removeClass("tappable-active")},home:function(){"undefined"=== typeof this.homePage&&(this.homePage=new directory.views.HomeView);this.displayView(this.homePage)},feedbackDisplay:function(){this.feedback=new directory.views.feedbackView;this.displayView(this.feedback)},creditPage:function(){this.creditPage=new directory.views.creditPageView;this.displayView(this.creditPage)},searchtaxon:function(){this.searchResults=new directory.models.TaxonCollection;var a=new directory.views.SearchPage({model:this.searchResults});this.displayView(a)},displayView:function(a){var b= this,c=[];if(this.currentView)c.push(this.currentView.close());else{var d=$.Deferred();c.push(d);d.resolve(!0)}$.when.apply(null,c).done(function(){a.render();b.currentView=a;b.pageHistory=[window.location.hash];$("#content").empty();$("#content").append(a.el);if(a.onAddToDom)a.onAddToDom()}).fail(function(){b.navigate(b.pageHistory[0])})},discoverGalleryList:function(){var a=new directory.views.GalleryListView({model:directory.data.galleriesList});this.displayView(a)},playListGallery:function(){var a= new directory.views.playListGalleryView({collection:directory.data.galleriesList,currentProfil:self.currentProfil});this.displayView(a)},playGameboardDisplay:function(a){var b=this,c=directory.data.galleriesList.findWhere({collectionid:a});c.set("id",a);this.currentProfil=new directory.models.Profil({Tprofil_PK_Id:1});this.currentProfil.fetch();if("false"==c.get("active"))return alert(c.get("active")),window.history.back(),!1;(new directory.models.ScoresCollection).fetch({success:function(d){var g= d.findWhere({fk_gallery:parseInt(a)});d.findScoreMaxByGallery().done(function(a){var e=0;_.each(a,function(a){e+=a.score_max});a=new directory.views.playGameboardView({model:c,currentProfil:b.currentProfil,lastScoreByGallery:g,scoreByfk_profil:d,ScoreGlobal:e});b.displayView(a)})}})},discoverGalleryTaxonomicTreeView:function(a){var b=directory.data.galleriesList.findWhere({collectionid:a});b.set("id",a);a=new directory.views.GalleryDetailView({model:b});this.displayView(a)},profilDisplay:function(a){var b= this;a=new directory.models.Profil({Tprofil_PK_Id:a});var c=new directory.models.ScoresCollection;a.fetch({success:function(a){c.bind("reset",b.render,b);c.findAllScoreByProfilId(a.get("Tprofil_PK_Id")).done(function(g){var h=0,e=1;_.each(g,function(a){var b=directory.data.galleriesList.galleryOrdreById(String(a.fk_gallery));b>e&&(e=b);h+=a.score_max});c.bind("change",b.render,b);g=new directory.views.ProfilDetailView({model:a,allScoreById:g,scoreTotal:h,ordreMax:e});c.bind("reset",b.render,b);b.displayView(g); c.bind("reset",b.render,b)})}})}});